<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=ISO-8859-1">
  <title>Build Workflow</title>

  <script src="js/libs/jquery-for-tree.js" type="text/javascript"></script>
  <script src="js/libs/jquery-ui.custom.js" type="text/javascript"></script>
  <script src="js/libs/jquery.cookie.js" type="text/javascript"></script>

  <link href="css/ui.dynatree.css" rel="stylesheet" type="text/css">
  <link href="css/tree-styles.css" rel="stylesheet" type="text/css">
  <script src="js/libs/jquery.dynatree.js" type="text/javascript"></script>

  <!-- (Irrelevant source removed.) -->

<script type="text/javascript"><!--
$(function(){
  // --- Initialize first Dynatree -------------------------------------------
  var nodeCounter = 0;
  //Function from http://stackoverflow.com/questions/105034/how-to-create-a-guid-uuid-in-javascript
  function guid() {
    return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
        var r = Math.random()*16|0, v = c == 'x' ? r : (r&0x3|0x8);
        return v.toString(16);
    });
  }
  
  function loadForm(key, type){
    console.log("Loading form for " + type);
    $("#nodeForm").html("Key: " + key + "<br>" + "Type: " + type );
  
  }
  
  
  $("#tree").dynatree({
    initAjax: {
      url: "data/sample-data1.js"
    },
    selectMode: 1,
    dnd: {
      preventVoidMoves: true, // Prevent dropping nodes 'before self', etc.
      onDragStart: function(node) {
        /** This function MUST be defined to enable dragging for the tree.
         *  Return false to cancel dragging of node.
         */
        return true;
      },
      onDragOver: function(node, sourceNode, hitMode) {
        /** Return false to disallow dropping this node.
         *
         */
        logMsg("tree.onDragOver(%o, %o, %o)", node, sourceNode, hitMode);
        // Prevent dropping a parent below it's own child
        if(node.isDescendantOf(sourceNode)){
          return false;
        }
        // Prohibit creating childs in non-folders (only sorting allowed)
        if( !node.data.isFolder && hitMode === "over" ){
          return "after";
        }
      },
      onDragEnter: function(node, sourceNode) {
        /** sourceNode may be null for non-dynatree droppables.
         *  Return false to disallow dropping on node. In this case
         *  onDragOver and onDragLeave are not called.
         *  Return 'over', 'before, or 'after' to force a hitMode.
         *  Return ['before', 'after'] to restrict available hitModes.
         *  Any other return value will calc the hitMode from the cursor position.
         */
        // Prevent dropping a parent below another parent (only sort
        // nodes under the same parent)
        //if(node.parent !== sourceNode.parent){
        //  return false;
        //}
        // Don't allow dropping *over* a node unless its a folder
        if( node.data.isFolder){
          return "over";
        }
        return ["before", "after"];
      },
      onDrop: function(node, sourceNode, hitMode, ui, draggable) {
         /* This function MUST be defined to enable dropping of items on the tree.
         * sourceNode may be null, if it is a non-Dynatree droppable.
         */
        logMsg("tree.onDrop(%o, %o)", node, sourceNode);
        var copynode;
        var guidKey = guid();
        if(sourceNode) {
            if( node.data.addClass === "decision" ){
                var guidKey = guid();
                decisionArrowNode = {title: "Option" + nodeCounter++, addClass: "decisionArrow", isFolder: true, key: guidKey};
                node.addChild(decisionArrowNode);
                var tree = $("#tree").dynatree("getTree");
                var parent = tree.getNodeByKey(guidKey);
                sourceNode.move(parent, hitMode);
                
                parent.expand(true);
                //;
            }
            else {
            sourceNode.move(node, hitMode);
            
            }
            var tree = $("#tree").dynatree("getTree");
            tree.selectKey(guidKey)
        }
        else{
            copynode = {title: ui.helper.nodeTitle + nodeCounter++, addClass: ui.helper.nodeClass, isFolder: ui.helper.nodeIsFolder, key: guidKey};
            if( node.data.addClass === "decision" ){
                var decisionGuidKey = guid();
                decisionArrowNode = {title: "Option" + nodeCounter++, addClass: "decisionArrow", isFolder: true, key: decisionGuidKey};
                node.addChild(decisionArrowNode);
                var tree = $("#tree").dynatree("getTree");
                var parent = tree.getNodeByKey(decisionGuidKey);
                parent.addChild(copynode);
                node.expand(true);
                parent.expand(true);
                
            }
            else {
                
                console.log("------------------");
                console.log(ui.helper);
                console.log("------------------");
                
                if(hitMode == "over"){
                  // Append as child node
                  node.addChild(copynode);
                  // expand the drop target
                  node.expand(true);
                }else if(hitMode == "before"){
                  // Add before this, i.e. as child of current parent
                  node.parent.addChild(copynode, node);
                }else if(hitMode == "after"){
                  // Add after this, i.e. as child of current parent
                  node.parent.addChild(copynode, node.getNextSibling());
                }
                
            }
            var tree = $("#tree").dynatree("getTree");
            tree.selectKey(guidKey)
      }
      },
      onDragLeave: function(node, sourceNode) {
        /** Always called if onDragEnter was called.
         */
        logMsg("tree.onDragLeave(%o, %o)", node, sourceNode);
      }
      
    },
      onQueryActivate: function(activate, node) {
        logMsg("onQueryActivate(%o, %o)", activate, node);
//        return false;
      },
      onActivate: function(node) {
        logMsg("onActivate(%o)", node);
        
        console.log("+++++++++++++++++++++");
      },
      onDeactivate: function(node) {
        logMsg("onDeactivate(%o)", node);
        
      },

      onQuerySelect: function(select, node) {
        logMsg("onQuerySelect(%o, %o)", select, node);
        if( node.data.isFolder )
          return false;
      },
      onSelect: function(select, node) {
        logMsg("onSelect(%o, %o)", node);
        var s = node.tree.getSelectedNodes().join(", ");
        loadForm(node.data.key, node.data.addClass)

      },
      onClick: function(node, event) {
        logMsg("onClick(%o, %o)", node, event);
        node.toggleSelect();
      },
      onDblClick: function(node, event) {
        logMsg("onDblClick(%o, %o)", node, event);
        
      },
      onKeydown: function(node, event) {
        logMsg("onKeydown(%o, %o)", node, event);
        switch( event.which ) {
        case 32: // [space]
          node.toggleSelect();
          return false;
        }
      },
      onKeypress: function(node, event) {
        logMsg("onKeypress(%o, %o)", node, event);
      }
  });
  
   $("#draggableTask").draggable({
//      revert: "invalid", // slide back, when dropping over non-target
    revert: function(dropped){
      // Return `true` to let the helper slide back.
      if(typeof dropped === "boolean"){
        // dropped == true, when dropped over a simple, valid droppable target.
        // false, when dropped outside a drop target.
        return !dropped;
      }
      // Drop comes from another tree. Default behavior is to assume
      // a valid drop, since we are over a drop-target.
      // Therefore we have to make an extra check, if the target node
      // was rejected by a Dynatree callback.
      var helper = $.ui.ddmanager && $.ui.ddmanager.current && $.ui.ddmanager.current.helper;
       helper.nodeTitle = "task";
       helper.nodeClass = "task";
       helper.nodeIsFolder = false;
      var isRejected = helper && helper.hasClass("dynatree-drop-reject");
      return isRejected;
      },
    connectToDynatree: true,
    cursorAt: { top: -5, left:-5 },
    helper: "clone"
  });
  
  $("#draggableDecision").draggable({

    revert: function(dropped){

      if(typeof dropped === "boolean"){
        return !dropped;
      }
      var helper = $.ui.ddmanager && $.ui.ddmanager.current && $.ui.ddmanager.current.helper;
       helper.nodeTitle = "decision";
       helper.nodeClass = "decision";
       helper.nodeIsFolder = true;
      var isRejected = helper && helper.hasClass("dynatree-drop-reject");
      return isRejected;
      },
    connectToDynatree: true,
    cursorAt: { top: -5, left:-5 },
    helper: "clone"
  });
  
  $("#draggableList").draggable({

    revert: function(dropped){

      if(typeof dropped === "boolean"){
        return !dropped;
      }
      var helper = $.ui.ddmanager && $.ui.ddmanager.current && $.ui.ddmanager.current.helper;
       helper.nodeTitle = "list";
       helper.nodeClass = "list";
       helper.nodeIsFolder = true;
      var isRejected = helper && helper.hasClass("dynatree-drop-reject");
      return isRejected;
      },
    connectToDynatree: true,
    cursorAt: { top: -5, left:-5 },
    helper: "clone"
  });
  $("#draggableScript").draggable({

    revert: function(dropped){

      if(typeof dropped === "boolean"){
        return !dropped;
      }
      var helper = $.ui.ddmanager && $.ui.ddmanager.current && $.ui.ddmanager.current.helper;
       helper.nodeTitle = "script";
       helper.nodeClass = "script";
       helper.nodeIsFolder = false;
      var isRejected = helper && helper.hasClass("dynatree-drop-reject");
      return isRejected;
      },
    connectToDynatree: true,
    cursorAt: { top: -5, left:-5 },
    helper: "clone"
  });
  $("#draggableLoop").draggable({

    revert: function(dropped){

      if(typeof dropped === "boolean"){
        return !dropped;
      }
      var helper = $.ui.ddmanager && $.ui.ddmanager.current && $.ui.ddmanager.current.helper;
       helper.nodeTitle = "loop";
       helper.nodeClass = "loop";
       helper.nodeIsFolder = true;
      var isRejected = helper && helper.hasClass("dynatree-drop-reject");
      return isRejected;
      },
    connectToDynatree: true,
    cursorAt: { top: -5, left:-5 },
    helper: "clone"
  });
  $("#draggableExit").draggable({

    revert: function(dropped){

      if(typeof dropped === "boolean"){
        return !dropped;
      }
      var helper = $.ui.ddmanager && $.ui.ddmanager.current && $.ui.ddmanager.current.helper;
       helper.nodeTitle = "exit";
       helper.nodeClass = "exit";
       helper.nodeIsFolder = false;
      var isRejected = helper && helper.hasClass("dynatree-drop-reject");
      return isRejected;
      },
    connectToDynatree: true,
    cursorAt: { top: -5, left:-5 },
    helper: "clone"
  });
  $("#draggableCopy").draggable({

    revert: function(dropped){

      if(typeof dropped === "boolean"){
        return !dropped;
      }
      var helper = $.ui.ddmanager && $.ui.ddmanager.current && $.ui.ddmanager.current.helper;
       helper.nodeTitle = "copy";
       helper.nodeClass = "copy";
       helper.nodeIsFolder = false;
      var isRejected = helper && helper.hasClass("dynatree-drop-reject");
      return isRejected;
      },
    connectToDynatree: true,
    cursorAt: { top: -5, left:-5 },
    helper: "clone"
  });
  $("#draggableServiceTask").draggable({

    revert: function(dropped){

      if(typeof dropped === "boolean"){
        return !dropped;
      }
      var helper = $.ui.ddmanager && $.ui.ddmanager.current && $.ui.ddmanager.current.helper;
       helper.nodeTitle = "serviceTask";
       helper.nodeClass = "serviceTask";
       helper.nodeIsFolder = false;
      var isRejected = helper && helper.hasClass("dynatree-drop-reject");
      return isRejected;
      },
    connectToDynatree: true,
    cursorAt: { top: -5, left:-5 },
    helper: "clone"
  });
  $("#draggableSubProcess").draggable({

    revert: function(dropped){

      if(typeof dropped === "boolean"){
        return !dropped;
      }
      var helper = $.ui.ddmanager && $.ui.ddmanager.current && $.ui.ddmanager.current.helper;
       helper.nodeTitle = "subProcess";
       helper.nodeClass = "subProcess";
       helper.nodeIsFolder = false;
      var isRejected = helper && helper.hasClass("dynatree-drop-reject");
      return isRejected;
      },
    connectToDynatree: true,
    cursorAt: { top: -5, left:-5 },
    helper: "clone"
  });
  $("#draggableDecisionArrow").draggable({

    revert: function(dropped){

      if(typeof dropped === "boolean"){
        return !dropped;
      }
      var helper = $.ui.ddmanager && $.ui.ddmanager.current && $.ui.ddmanager.current.helper;
       helper.nodeTitle = "decisionArrow";
       helper.nodeClass = "decisionArrow";
       helper.nodeIsFolder = true;
      var isRejected = helper && helper.hasClass("dynatree-drop-reject");
      return isRejected;
      },
    connectToDynatree: true,
    cursorAt: { top: -5, left:-5 },
    helper: "clone"
  });
});
--></script>
</head>

<body class="example">
  

  
  <table id="dropItem">
  <tr>
    <td>
    <div id="draggableTask">
        <img src="images/Icon_Task.png" alt="task" title="task" height="25" width="25">
    </div>
    <td>
    <td>
    <div id="draggableDecision">
        <img src="images/Icon_Decision.png" alt="decision" title="decision" height="25" width="25">
    </div>
    <td>
    <td>
    <div id="draggableList">
        <img src="images/Icon_List.png" alt="list" title="list" height="25" width="25">
    </div>
    <td>
    <td>
    <div id="draggableScript">
        <img src="images/Icon_Script.png" alt="script" title="script" height="25" width="25">
    </div>
    <td>
    <td>
    <div id="draggableLoop">
        <img src="images/Icon_Loop.png" alt="loop" title="loop" height="25" width="25">
    </div>
    <td>
    <td>
    <div id="draggableExit">
        <img src="images/Icon_Exit.png" alt="exit" title="exit" height="25" width="25">
    </div>
    <td>
    <td>
    <div id="draggableCopy">
        <img src="images/Icon_Copy.png" alt="copy" title="copy" height="25" width="25">
    </div>
    <td>
    <td>
    <div id="draggableServiceTask">
        <img src="images/Icon_ServiceTask.png" alt="service task" title="service task" height="25" width="25">
    </div>
    <td>
    <td>
    <div id="draggableSubProcess">
        <img src="images/Icon_SubProcess.png" alt="subProccess"  title="subProccess"height="25" width="25">
    </div>
    <td>
    <!--td>
    <div id="draggableDecisionArrow">
        <img src="images/Icon_Decision_Arrow.png" alt="decision arrow" title="decision arrow" height="25" width="25">
    </div>
    <td-->
  </tr>
  </table>
  
  
  <div id="tree">  </div>
  <div id="nodeForm"> TESTING </div>

  <!-- (Irrelevant source removed.) -->
</body>
</html>